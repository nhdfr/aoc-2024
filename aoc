#!/usr/bin/env bash
# AOC Main Script - Single entry point for Advent of Code operations
# Usage: 
#   ./aoc.sh <day>           - Setup and fetch problem for day
#   ./aoc.sh -test <day>     - Test solutions and show output
#   ./aoc.sh -submit <day>   - Run and submit solutions

set -e

# Configuration
YEAR=2024
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AOC_DIR="$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Helper functions
print_header() {
    echo -e "${PURPLE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${PURPLE}ğŸ„ Advent of Code $YEAR - Day $1${NC}"
    echo -e "${PURPLE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

print_usage() {
    echo -e "${CYAN}Usage:${NC}"
    echo -e "  ${GREEN}./aoc <day>${NC}             - Setup and fetch problem for day"
    echo -e "  ${GREEN}./aoc -test <day>${NC}       - Test solutions and show output"
    echo -e "  ${GREEN}./aoc -run <day>${NC}        - Dry run - show answers without submitting"
    echo -e "  ${GREEN}./aoc -submit <day>${NC}     - Run and submit solutions"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${YELLOW}./aoc 3${NC}                - Setup day 3"
    echo -e "  ${YELLOW}./aoc -test 3${NC}          - Test day 3 solutions"
    echo -e "  ${YELLOW}./aoc -run 3${NC}           - Show day 3 answers (dry run)"
    echo -e "  ${YELLOW}./aoc -submit 3${NC}        - Submit day 3 solutions"
}

setup_day() {
    local day=$1
    local day_padded=$(printf "%02d" $day)
    local day_dir="$AOC_DIR/$YEAR/day$day_padded"
    
    print_header $day
    echo -e "${BLUE}> Setting up Day $day...${NC}"
    
    # Create directory structure
    mkdir -p "$day_dir"
    
    # Create meta.json
    cat > "$day_dir/meta.json" << EOF
{
  "part1Submitted": false,
  "part2Submitted": false
}
EOF

    # Create main.go
    cat > "$day_dir/main.go" << EOF
package main

import (
	"fmt"
	"os"
)

func main() {
	input, err := os.ReadFile("input.txt")
	if err != nil {
		panic(err)
	}

	example, err := os.ReadFile("example.txt")
	hasExample := err == nil && len(example) > 0

	if hasExample {
		fmt.Println("Example Tests:")
		fmt.Println("Part 1 (Example):", solvePart1(string(example)))
		fmt.Println("Part 2 (Example):", solvePart2(string(example)))
		fmt.Println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
	}

	fmt.Println("Actual Input:")
	fmt.Println("Part 1:", solvePart1(string(input)))
	fmt.Println("Part 2:", solvePart2(string(input)))
}
EOF

    # Create part1.go
    cat > "$day_dir/part1.go" << EOF
package main

import (
	"strconv"
	"strings"
)

func solvePart1(input string) interface{} {
	lines := strings.Split(strings.TrimSpace(input), "\n")
	
	// TODO: Implement Part 1 solution
	result := 0
	
	for _, line := range lines {
		if line == "" {
			continue
		}
		// Your solution here
		_ = line
	}

	return result
}
EOF

    # Create part2.go
    cat > "$day_dir/part2.go" << EOF
package main

import (
	"strconv"
	"strings"
)

func solvePart2(input string) interface{} {
	lines := strings.Split(strings.TrimSpace(input), "\n")
	
	// TODO: Implement Part 2 solution
	result := 0
	
	for _, line := range lines {
		if line == "" {
			continue
		}
		// Your solution here
		_ = line
	}

	return result
}
EOF

    # Create empty files
    touch "$day_dir/input.txt"
    touch "$day_dir/example.txt"
    
    # Fetch input and problem if session token exists
    if [ -f "$AOC_DIR/.env" ] && grep -q "AOC_SESSION" "$AOC_DIR/.env"; then
        echo -e "${YELLOW}> Fetching input...${NC}"
        
        # Change to day directory and run fetch from there
        cd "$day_dir"
        
        # Copy .env to current directory temporarily for fetch
        cp "$AOC_DIR/.env" .
        
        if go run "$AOC_DIR/fetch.go" $YEAR $day 2>/tmp/aoc_fetch_error; then
            echo -e "${GREEN}> Input fetched successfully${NC}"
        else
            echo -e "${RED}> Failed to fetch input${NC}"
            if [ -s /tmp/aoc_fetch_error ]; then
                echo -e "${YELLOW}Error details:${NC}"
                cat /tmp/aoc_fetch_error | head -3
            fi
            echo -e "${CYAN}> Manually add your input to: input.txt${NC}"
            rm -f /tmp/aoc_fetch_error
        fi
        
        # Clean up temporary .env file
        rm -f .env
        cd "$AOC_DIR"
    else
        echo -e "${YELLOW}>  No AOC_SESSION found in .env file${NC}"
        echo -e "${CYAN}> Manually add your input to: $day_dir/input.txt${NC}"
    fi
    
    echo -e "${GREEN}> Day $day setup complete!${NC}"
    echo -e "${CYAN}> Directory: $day_dir${NC}"
    echo -e "${CYAN}> Edit part1.go and part2.go to implement your solutions${NC}"
}

test_day() {
    local day=$1
    local day_padded=$(printf "%02d" $day)
    local day_dir="$AOC_DIR/$YEAR/day$day_padded"
    
    print_header $day
    echo -e "${BLUE}> Testing Day $day solutions...${NC}"
    
    if [ ! -d "$day_dir" ]; then
        echo -e "${RED}> Day $day not found. Run './aoc.sh $day' first to set it up.${NC}"
        exit 1
    fi
    
    cd "$day_dir"
    
    # Check if solutions are implemented
    if grep -q "TODO: Implement" part1.go; then
        echo -e "${YELLOW} Part 1 not implemented yet (contains TODO)${NC}"
    fi
    
    if grep -q "TODO: Implement" part2.go; then
        echo -e "${YELLOW} Part 2 not implemented yet (contains TODO)${NC}"
    fi
    
    echo -e "${CYAN}Running solutions...${NC}"
    
    # Test compilation first
    if ! go build -o /dev/null . 2>/dev/null; then
        echo -e "${RED} Code doesn't compile. Check for syntax errors.${NC}"
        cd "$AOC_DIR"
        return 1
    fi
    
    # Run the solution
    go run . 2>/dev/null || echo -e "${RED} Runtime error in solutions${NC}"
    
    cd "$AOC_DIR"
}

dry_run() {
    local day=$1
    local day_padded=$(printf "%02d" $day)
    local day_dir="$AOC_DIR/$YEAR/day$day_padded"
    
    print_header $day
    echo -e "${BLUE}ğŸ§ª Dry Run - Day $day (No Submission)${NC}"
    
    if [ ! -d "$day_dir" ]; then
        echo -e "${RED} Day $day not found. Run './aoc $day' first to set it up.${NC}"
        exit 1
    fi
    
    cd "$day_dir"
    
    # Check if solutions are implemented
    if grep -q "TODO: Implement" part1.go; then
        echo -e "${YELLOW}  Part 1 not implemented yet (contains TODO)${NC}"
    fi
    
    if grep -q "TODO: Implement" part2.go; then
        echo -e "${YELLOW}  Part 2 not implemented yet (contains TODO)${NC}"
    fi
    
    # Test compilation first
    if ! go build -o /dev/null . 2>/dev/null; then
        echo -e "${RED} Code doesn't compile. Check for syntax errors.${NC}"
        cd "$AOC_DIR"
        return 1
    fi
    
    echo -e "${CYAN} Running solutions (dry run mode)...${NC}"
    
    # Run the solution and parse output
    output=$(go run . 2>/dev/null)
    if [ $? -ne 0 ]; then
        echo -e "${RED} Runtime error in solutions${NC}"
        cd "$AOC_DIR"
        return 1
    fi
    
    # Parse and display results nicely
    echo "$output" | while IFS= read -r line; do
        if [[ "$line" == *"Part 1:"* ]]; then
            part1_result=$(echo "$line" | cut -d':' -f2 | xargs)
            echo -e "${GREEN}Part 1 Answer:${NC} ${CYAN}$part1_result${NC}"
            echo -e "${YELLOW}Ready to submit: ./aoc -submit $day${NC}"
        elif [[ "$line" == *"Part 2:"* ]]; then
            part2_result=$(echo "$line" | cut -d':' -f2 | xargs)
            echo -e "${GREEN}Part 2 Answer:${NC} ${CYAN}$part2_result${NC}"
        elif [[ "$line" == *"Example"* ]] || [[ "$line" == *"Actual"* ]] || [[ "$line" == *"â”€â”€"* ]]; then
            echo -e "${PURPLE}$line${NC}"
        else
            echo "$line"
        fi
    done
    
    echo -e "\n${BLUE}Dry Run Complete - No answers were submitted${NC}"
    
    cd "$AOC_DIR"
}

submit_day() {
    local day=$1
    local day_padded=$(printf "%02d" $day)
    local day_dir="$AOC_DIR/$YEAR/day$day_padded"
    
    print_header $day
    echo -e "${BLUE}Running Day $day submission workflow...${NC}"
    
    if [ ! -d "$day_dir" ]; then
        echo -e "${RED}Day $day not found. Run './aoc $day' first to set it up.${NC}"
        exit 1
    fi
    
    # Use the submission logic
    go run "$AOC_DIR/submit.go" $YEAR $day
}

# Main script logic
case "$1" in
    -test)
        if [ -z "$2" ]; then
            echo -e "${RED}Day number required for -test${NC}"
            print_usage
            exit 1
        fi
        test_day "$2"
        ;;
    -run)
        if [ -z "$2" ]; then
            echo -e "${RED} Day number required for -run${NC}"
            print_usage
            exit 1
        fi
        dry_run "$2"
        ;;
    -submit)
        if [ -z "$2" ]; then
            echo -e "${RED} Day number required for -submit${NC}"
            print_usage
            exit 1
        fi
        submit_day "$2"
        ;;
    -h|--help|help)
        print_usage
        ;;
    "")
        print_usage
        ;;
    *)
        if [[ "$1" =~ ^[0-9]+$ ]]; then
            setup_day "$1"
        else
            echo -e "${RED} Invalid option: $1${NC}"
            print_usage
            exit 1
        fi
        ;;
esac
